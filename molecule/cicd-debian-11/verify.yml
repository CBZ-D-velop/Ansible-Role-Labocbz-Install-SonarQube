---
# Don't forget to keep this file updated
# molecule/<scenario>/verify.yml
- name: "Verify"
  hosts: "all"
  gather_facts: false
  tasks:

    - name: "Get PostgreSQL service current state"
      register: install_postgresql_service_status
      failed_when: not install_postgresql_service_status.status.ActiveState == 'active'
      ansible.builtin.systemd:
        name: "postgresql"

    - name: "Get SonarQube service current state"
      register: install_sonarqube_service_status
      failed_when: not install_sonarqube_service_status.status.ActiveState == 'active'
      ansible.builtin.systemd:
        name: "sonarqube"

    - name: "Check TCP connectivities"
      block:
        - name: "Check PostgreSQL connectivity"
          ansible.builtin.wait_for:
            host: "127.0.0.1"
            port: "5432"
            timeout: 120

        - name: "Check Elasticsearch connectivity"
          ansible.builtin.wait_for:
            host: "localhost"
            port: "{{ inv_install_sonarqube_elasticsearch_port }}"
            timeout: 120

        - name: "Check SonarQube connectivity"
          ansible.builtin.wait_for:
            host: "localhost"
            port: "{{ inv_install_sonarqube_web_port }}"
            timeout: 120

        - name: "Check SonarQube HTTP URL"
          register: result
          failed_when: result.status != 200
          ansible.builtin.uri:
            url: "http://localhost:{{ inv_install_sonarqube_web_port }}"
            method: "GET"
